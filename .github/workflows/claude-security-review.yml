name: Claude Security Review

on:
  repository_dispatch:
    types: [claude-security-review]

concurrency:
  group: claude-security-review
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  id-token: write

jobs:
  security-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.client_payload.sha || github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get last review commit
        id: last-review
        run: |
          if git rev-parse last-security-review >/dev/null 2>&1; then
            echo "sha=$(git rev-parse last-security-review)" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "sha=$(git rev-list --max-parents=0 HEAD)" >> $GITHUB_OUTPUT
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Get diff summary
        id: diff
        run: |
          CURRENT_SHA="${{ github.event.client_payload.sha || github.sha }}"
          DIFF=$(git diff --stat ${{ steps.last-review.outputs.sha }}..$CURRENT_SHA)
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review ONLY the changes since the last security review. DO NOT write a report.

            Last reviewed commit: ${{ steps.last-review.outputs.sha }}
            Current commit: ${{ github.event.client_payload.sha || github.sha }}

            Changes to review:
            ${{ steps.diff.outputs.changes }}

            Use: git diff ${{ steps.last-review.outputs.sha }}..${{ github.event.client_payload.sha || github.sha }}

            Repository visibility:
            - home-manager (this repo): PUBLIC
            - infra submodule (Ja-sonYun/server): PRIVATE
            - shell/secrets/agenix submodule (Ja-sonYun/agenix-secrets): PRIVATE
            - portable/plot, portable/say, portable/vim/dev/lsp: PUBLIC
            - .mkutils: PUBLIC

            Focus on PUBLIC repositories - sensitive data in PRIVATE submodules is acceptable.

            Check for:
            1. Exposed secrets, API keys, tokens, or credentials in PUBLIC areas
            2. Shell configurations with security vulnerabilities
            3. Nix configurations with insecure settings
            4. Overly permissive file permissions
            5. Hardcoded sensitive information that shouldn't be public

            IMPORTANT:
            - If you find security issues, IMMEDIATELY create a GitHub Issue using: gh issue create --title "[Security] ..." --label "security" --body "..."
            - Do NOT ask for permission, just create the issue directly.
            - Do NOT write a report or summary. Only create issues.
            - If no issues found, just output "No security issues found".
          claude_args: "--max-turns 50 --allowed-tools 'Bash(gh issue create:*),Bash(gh issue list:*),Bash(git diff:*),Bash(git log:*),Read,Glob,Grep'"

      - name: Update last review tag
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_SHA="${{ github.event.client_payload.sha || github.sha }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git tag -f last-security-review $CURRENT_SHA
          git push origin last-security-review --force
