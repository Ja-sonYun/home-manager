name: Claude Security Review

on:
  push:
    branches: [main]

concurrency:
  group: claude-security-review
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  security-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - uses: anthropics/claude-code-action@v1
        with:
          use_oauth: true
          prompt: |
            Review this dotfiles repository for security risks. Use multiple agents to thoroughly analyze:

            Repository visibility:
            - home-manager (this repo): PUBLIC
            - infra submodule (Ja-sonYun/server): PRIVATE
            - shell/secrets/agenix submodule (Ja-sonYun/agenix-secrets): PRIVATE
            - portable/plot, portable/say, portable/vim/dev/lsp: PUBLIC
            - .mkutils: PUBLIC

            Focus on PUBLIC repositories - sensitive data in PRIVATE submodules is acceptable.

            Check for:
            1. Exposed secrets, API keys, tokens, or credentials in PUBLIC areas
            2. Shell configurations with security vulnerabilities
            3. Nix configurations with insecure settings
            4. Overly permissive file permissions
            5. Hardcoded sensitive information that shouldn't be public

            Focus on the changes in this push.

            If you find ANY security issues:
            - Create a GitHub Issue with title "[Security] Potential vulnerabilities found in commit <short-sha>"
            - Label it with "security"
            - Include detailed findings and recommendations

            If no issues found, just output "No security issues found" to the summary.
          claude_args: "--max-turns 10"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
