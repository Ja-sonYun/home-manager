#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "$0")/.." && pwd)
HASH_FILE="$ROOT_DIR/pkgs/hash.nix"
UPDATE_SCRIPT="$ROOT_DIR/scripts/update-output-hash"

if [[ ! -x "$UPDATE_SCRIPT" ]]; then
  echo "Update script not executable: $UPDATE_SCRIPT" >&2
  exit 1
fi

if [[ ! -f "$HASH_FILE" ]]; then
  echo "Hash map not found: $HASH_FILE" >&2
  exit 1
fi

read_entries() {
  python3 - "$HASH_FILE" <<'PY'
import sys
from pathlib import Path

path = Path(sys.argv[1])

if not path.exists():
    sys.exit(0)

entries = []
for line in path.read_text().splitlines():
    raw = line.strip()
    if not raw or raw in {'{', '}'}:
        continue
    if raw.startswith('#'):
        continue
    if raw.endswith(';'):
        raw = raw[:-1].strip()
    if '=' not in raw:
        continue
    key, _ = raw.split('=', 1)
    entries.append(key.strip().strip('"'))

for entry in sorted(entries):
    print(entry)
PY
}

declare -a targets

if [[ $# -gt 0 ]]; then
  for arg in "$@"; do
    if [[ "$arg" == pkgs/* ]]; then
      targets+=("${arg#pkgs/}")
    else
      targets+=("$arg")
    fi
  done
else
  mapfile -t targets < <(read_entries)
fi

if [[ ${#targets[@]} -eq 0 ]]; then
  echo "No targets found." >&2
  exit 1
fi

for rel_path in "${targets[@]}"; do
  target_file="$ROOT_DIR/pkgs/$rel_path"
  if [[ ! -f "$target_file" ]]; then
    echo "Skipping missing file: $rel_path" >&2
    continue
  fi
  echo "Updating $rel_path"
  if ! "$UPDATE_SCRIPT" "$target_file"; then
    echo "Failed updating $rel_path" >&2
    exit 1
  fi
done

echo "All requested output hashes refreshed."
