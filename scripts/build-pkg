#!/usr/bin/env bash
# Written in [Amber](https://amber-lang.com/)
# version: 0.4.0-alpha
# date: 2025-12-12 20:53:47
echo_info__0_v0() {
    local msg=$1
     tput bold; tput setaf 4; echo "${msg}"; tput sgr0 ;
    __AS=$?
}
echo_success__1_v0() {
    local msg=$1
     tput bold; tput setaf 2; echo "${msg}"; tput sgr0 ;
    __AS=$?
}
echo_warning__2_v0() {
    local msg=$1
     tput bold; tput setaf 3; echo "${msg}"; tput sgr0 ;
    __AS=$?
}
echo_error__3_v0() {
    local msg=$1
     tput bold; tput setaf 1; echo "${msg}" >&2; tput sgr0 ;
    __AS=$?
}
get_root_dir__6_v0() {
    __AMBER_VAL_0=$( cd "$(dirname "$0")" && pwd );
    __AS=$?;
    local script_dir="${__AMBER_VAL_0}"
    __AMBER_VAL_1=$( cd "${script_dir}/.." && pwd );
    __AS=$?;
    local root="${__AMBER_VAL_1}"
    __AF_get_root_dir6_v0="${root}";
    return 0
}
get_hashfile_path__7_v0() {
    local root_dir=$1
    __AF_get_hashfile_path7_v0="${root_dir}/pkgs/hashfile.json";
    return 0
}
get_hostname__8_v0() {
    __AMBER_VAL_2=$( hostname );
    __AS=$?;
    local h="${__AMBER_VAL_2}"
    __AF_get_hostname8_v0="${h}";
    return 0
}
text_contains__24_v0() {
    local text=$1
    local phrase=$2
    __AMBER_VAL_3=$( if [[ "${text}" == *"${phrase}"* ]]; then
    echo 1
  fi );
    __AS=$?;
    local result="${__AMBER_VAL_3}"
    __AF_text_contains24_v0=$([ "_${result}" != "_1" ]; echo $?);
    return 0
}

is_command__104_v0() {
    local command=$1
     [ -x "$(command -v ${command})" ] ;
    __AS=$?;
if [ $__AS != 0 ]; then
        __AF_is_command104_v0=0;
        return 0
fi
    __AF_is_command104_v0=1;
    return 0
}
printf__110_v0() {
    local format=$1
    local args=("${!2}")
     args=("${format}" "${args[@]}") ;
    __AS=$?
     printf "${args[@]}" ;
    __AS=$?
}
echo_error__120_v0() {
    local message=$1
    local exit_code=$2
    __AMBER_ARRAY_4=("${message}");
    printf__110_v0 "\x1b[1;3;97;41m%s\x1b[0m
" __AMBER_ARRAY_4[@];
    __AF_printf110_v0__162_5="$__AF_printf110_v0";
    echo "$__AF_printf110_v0__162_5" > /dev/null 2>&1
    if [ $(echo ${exit_code} '>' 0 | bc -l | sed '/\./ s/\.\{0,1\}0\{1,\}$//') != 0 ]; then
        exit ${exit_code}
fi
}
require_cmd__123_v0() {
    local name=$1
    is_command__104_v0 "${name}";
    __AF_is_command104_v0__5_12="$__AF_is_command104_v0";
    if [ $(echo  '!' "$__AF_is_command104_v0__5_12" | bc -l | sed '/\./ s/\.\{0,1\}0\{1,\}$//') != 0 ]; then
        echo_error__120_v0 "Missing command: ${name}" 1;
        __AF_echo_error120_v0__6_9="$__AF_echo_error120_v0";
        echo "$__AF_echo_error120_v0__6_9" > /dev/null 2>&1
        exit 1
fi
}
__0_g_debug=0
set_debug__126_v0() {
    local val=$1
    __0_g_debug=${val}
}
debug__127_v0() {
    local msg=$1
    if [ ${__0_g_debug} != 0 ]; then
         echo "[DEBUG] ${msg}" >&2 ;
        __AS=$?
fi
}
detect_pkg_type__131_v0() {
    local file=$1
    __AMBER_VAL_5=$( rg -c "mkNpmGlobalPackageDerivation" "${file}" 2>/dev/null || echo "0" );
    __AS=$?;
    local npm_check="${__AMBER_VAL_5}"
    if [ $([ "_${npm_check}" == "_0" ]; echo $?) != 0 ]; then
        __AF_detect_pkg_type131_v0="npm";
        return 0
fi
    __AMBER_VAL_6=$( rg -c "mkPipGlobalPackageDerivation" "${file}" 2>/dev/null || echo "0" );
    __AS=$?;
    local pip_check="${__AMBER_VAL_6}"
    if [ $([ "_${pip_check}" == "_0" ]; echo $?) != 0 ]; then
        __AF_detect_pkg_type131_v0="pip";
        return 0
fi
    __AMBER_VAL_7=$( rg -c "mkCargoGlobalPackageDerivation" "${file}" 2>/dev/null || echo "0" );
    __AS=$?;
    local cargo_check="${__AMBER_VAL_7}"
    if [ $([ "_${cargo_check}" == "_0" ]; echo $?) != 0 ]; then
        __AF_detect_pkg_type131_v0="cargo";
        return 0
fi
    __AF_detect_pkg_type131_v0="";
    return 0
}
extract_hash_key__132_v0() {
    local file=$1
    __AMBER_VAL_8=$( sed -n 's/.*pkgs\.hashfile\."\([^"]*\)".*/\1/p' "${file}" | head -n1 );
    __AS=$?;
    local key="${__AMBER_VAL_8}"
    debug__127_v0 "Extracted hash key: ${key}";
    __AF_debug127_v0__24_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__24_5" > /dev/null 2>&1
    __AF_extract_hash_key132_v0="${key}";
    return 0
}
__1_g_debug=0
debug__142_v0() {
    local msg=$1
    if [ ${__1_g_debug} != 0 ]; then
         echo "[DEBUG] ${msg}" >&2 ;
        __AS=$?
fi
}
sed_inplace__144_v0() {
    local script=$1
    local file=$2
    debug__142_v0 "sed_inplace on ${file}: ${script}";
    __AF_debug142_v0__5_5="$__AF_debug142_v0";
    echo "$__AF_debug142_v0__5_5" > /dev/null 2>&1
    __AMBER_VAL_9=$( sed --version 2>&1 | head -1 || echo "" );
    __AS=$?;
    local gnu_check="${__AMBER_VAL_9}"
    if [ $([ "_${gnu_check}" == "_" ]; echo $?) != 0 ]; then
         sed -i -e "${script}" "${file}" ;
        __AS=$?;
if [ $__AS != 0 ]; then
__AF_sed_inplace144_v0=''
return $__AS
fi
else
         sed -i '' -e "${script}" "${file}" ;
        __AS=$?;
if [ $__AS != 0 ]; then
__AF_sed_inplace144_v0=''
return $__AS
fi
fi
}
nix_build__149_v0() {
    local root_dir=$1
    local file=$2
    local key=$3
    get_hostname__8_v0 ;
    __AF_get_hostname8_v0__8_20="${__AF_get_hostname8_v0}";
    local hostname="${__AF_get_hostname8_v0__8_20}"
    local abs_file="${file}"
    __AMBER_VAL_10=$( echo "${file}" | grep -q "^/" && echo "1" || echo "0" );
    __AS=$?;
    local is_abs="${__AMBER_VAL_10}"
    if [ $([ "_${is_abs}" != "_0" ]; echo $?) != 0 ]; then
        abs_file="${root_dir}/${file}"
fi
    debug__127_v0 "Building: ${abs_file} (key=${key}, hostname=${hostname})";
    __AF_debug127_v0__16_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__16_5" > /dev/null 2>&1
    __AMBER_VAL_11=$( mktemp -t build-pkg );
    __AS=$?;
    local tmpbase="${__AMBER_VAL_11}"
    local tmpfile="${tmpbase}.nix"
     mv "${tmpbase}" "${tmpfile}" ;
    __AS=$?
    __AMBER_VAL_12=$( cd "$(dirname "$0")" && pwd );
    __AS=$?;
    local script_dir="${__AMBER_VAL_12}"
    local template="${script_dir}/src/build-pkg/template.nix"
     cp "${template}" "${tmpfile}" ;
    __AS=$?
    sed_inplace__144_v0 "s|__HOSTNAME__|${hostname}|g" "${tmpfile}";
    __AS=$?;
    __AF_sed_inplace144_v0__26_11="$__AF_sed_inplace144_v0";
    echo "$__AF_sed_inplace144_v0__26_11" > /dev/null 2>&1
    sed_inplace__144_v0 "s|__ROOT_DIR__|${root_dir}|g" "${tmpfile}";
    __AS=$?;
    __AF_sed_inplace144_v0__27_11="$__AF_sed_inplace144_v0";
    echo "$__AF_sed_inplace144_v0__27_11" > /dev/null 2>&1
    sed_inplace__144_v0 "s|__FILE__|${abs_file}|g" "${tmpfile}";
    __AS=$?;
    __AF_sed_inplace144_v0__28_11="$__AF_sed_inplace144_v0";
    echo "$__AF_sed_inplace144_v0__28_11" > /dev/null 2>&1
    debug__127_v0 "Nix file: ${tmpfile}";
    __AF_debug127_v0__29_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__29_5" > /dev/null 2>&1
    __AMBER_VAL_13=$( mktemp -t build-pkg-out );
    __AS=$?;
    local outfile="${__AMBER_VAL_13}"
     nix build --impure --file "${tmpfile}" -L > "${outfile}" 2>&1 || true ;
    __AS=$?
    __AMBER_VAL_14=$( cat "${outfile}" );
    __AS=$?;
    local out="${__AMBER_VAL_14}"
     rm -f "${tmpfile}" "${outfile}" ;
    __AS=$?
    __AF_nix_build149_v0="${out}";
    return 0
}
extract_hash_from_output__150_v0() {
    local out=$1
    __AMBER_VAL_15=$( echo "${out}" | sed -n 's/.*got: *\(sha256-[A-Za-z0-9+/=]\+\).*/\1/p' | tail -n1 );
    __AS=$?;
    local hash="${__AMBER_VAL_15}"
    __AF_extract_hash_from_output150_v0="${hash}";
    return 0
}
update_hashfile__151_v0() {
    local root_dir=$1
    local key=$2
    local hash=$3
    get_hashfile_path__7_v0 "${root_dir}";
    __AF_get_hashfile_path7_v0__44_20="${__AF_get_hashfile_path7_v0}";
    local hashfile="${__AF_get_hashfile_path7_v0__44_20}"
    get_hostname__8_v0 ;
    __AF_get_hostname8_v0__45_20="${__AF_get_hostname8_v0}";
    local hostname="${__AF_get_hostname8_v0__45_20}"
    debug__127_v0 "Updating hashfile: ${hashfile}";
    __AF_debug127_v0__47_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__47_5" > /dev/null 2>&1
    debug__127_v0 "Hostname: ${hostname}, Key: ${key}, Hash: ${hash}";
    __AF_debug127_v0__48_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__48_5" > /dev/null 2>&1
    __AMBER_VAL_16=$( jq --arg host "${hostname}" --arg key "${key}" --arg hash "${hash}" '.[$host][$key] = $hash' "${hashfile}" );
    __AS=$?;
    local updated="${__AMBER_VAL_16}"
    if [ $([ "_${updated}" != "_" ]; echo $?) != 0 ]; then
        __AF_update_hashfile151_v0=0;
        return 0
fi
     echo "${updated}" > "${hashfile}" ;
    __AS=$?
    __AF_update_hashfile151_v0=1;
    return 0
}
build_package__152_v0() {
    local root_dir=$1
    local file=$2
    local key=$3
    nix_build__149_v0 "${root_dir}" "${file}" "${key}";
    __AF_nix_build149_v0__61_15="${__AF_nix_build149_v0}";
    local out="${__AF_nix_build149_v0__61_15}"
    text_contains__24_v0 "${out}" "got:";
    __AF_text_contains24_v0__62_20="$__AF_text_contains24_v0";
    local has_hash="$__AF_text_contains24_v0__62_20"
    text_contains__24_v0 "${out}" "error:";
    __AF_text_contains24_v0__63_21="$__AF_text_contains24_v0";
    local has_error="$__AF_text_contains24_v0__63_21"
    if [ ${has_hash} != 0 ]; then
        extract_hash_from_output__150_v0 "${out}";
        __AF_extract_hash_from_output150_v0__66_24="${__AF_extract_hash_from_output150_v0}";
        local new_hash="${__AF_extract_hash_from_output150_v0__66_24}"
        if [ $([ "_${new_hash}" != "_" ]; echo $?) != 0 ]; then
            echo_error__3_v0 "Failed to extract hash from build output";
            __AF_echo_error3_v0__68_13="$__AF_echo_error3_v0";
            echo "$__AF_echo_error3_v0__68_13" > /dev/null 2>&1
            __AF_build_package152_v0=0;
            return 0
fi
        echo_warning__2_v0 "Hash mismatch detected. New hash: ${new_hash}";
        __AF_echo_warning2_v0__72_9="$__AF_echo_warning2_v0";
        echo "$__AF_echo_warning2_v0__72_9" > /dev/null 2>&1
        update_hashfile__151_v0 "${root_dir}" "${key}" "${new_hash}";
        __AF_update_hashfile151_v0__74_16="$__AF_update_hashfile151_v0";
        if [ $(echo  '!' "$__AF_update_hashfile151_v0__74_16" | bc -l | sed '/\./ s/\.\{0,1\}0\{1,\}$//') != 0 ]; then
            echo_error__3_v0 "Failed to update hashfile";
            __AF_echo_error3_v0__75_13="$__AF_echo_error3_v0";
            echo "$__AF_echo_error3_v0__75_13" > /dev/null 2>&1
            __AF_build_package152_v0=0;
            return 0
fi
        echo_success__1_v0 "Updated hashfile.json with new hash";
        __AF_echo_success1_v0__79_9="$__AF_echo_success1_v0";
        echo "$__AF_echo_success1_v0__79_9" > /dev/null 2>&1
        nix_build__149_v0 "${root_dir}" "${file}" "${key}";
        __AF_nix_build149_v0__81_27="${__AF_nix_build149_v0}";
        local rebuild_out="${__AF_nix_build149_v0__81_27}"
        text_contains__24_v0 "${rebuild_out}" "got:";
        __AF_text_contains24_v0__82_12="$__AF_text_contains24_v0";
        if [ "$__AF_text_contains24_v0__82_12" != 0 ]; then
            echo_error__3_v0 "Rebuild still failed after hash update";
            __AF_echo_error3_v0__83_13="$__AF_echo_error3_v0";
            echo "$__AF_echo_error3_v0__83_13" > /dev/null 2>&1
             echo "${rebuild_out}" >&2 ;
            __AS=$?
            __AF_build_package152_v0=0;
            return 0
fi
        text_contains__24_v0 "${rebuild_out}" "error:";
        __AF_text_contains24_v0__88_12="$__AF_text_contains24_v0";
        if [ "$__AF_text_contains24_v0__88_12" != 0 ]; then
            echo_error__3_v0 "Build failed with error";
            __AF_echo_error3_v0__89_13="$__AF_echo_error3_v0";
            echo "$__AF_echo_error3_v0__89_13" > /dev/null 2>&1
             echo "${rebuild_out}" >&2 ;
            __AS=$?
            __AF_build_package152_v0=0;
            return 0
fi
        echo_success__1_v0 "Rebuild successful"'!'"";
        __AF_echo_success1_v0__94_9="$__AF_echo_success1_v0";
        echo "$__AF_echo_success1_v0__94_9" > /dev/null 2>&1
        __AF_build_package152_v0=1;
        return 0
fi
    if [ ${has_error} != 0 ]; then
        echo_error__3_v0 "Build failed";
        __AF_echo_error3_v0__99_9="$__AF_echo_error3_v0";
        echo "$__AF_echo_error3_v0__99_9" > /dev/null 2>&1
        debug__127_v0 "Output: ${out}";
        __AF_debug127_v0__100_9="$__AF_debug127_v0";
        echo "$__AF_debug127_v0__100_9" > /dev/null 2>&1
        __AF_build_package152_v0=0;
        return 0
fi
    echo_success__1_v0 "Build successful (no hash update needed)";
    __AF_echo_success1_v0__104_5="$__AF_echo_success1_v0";
    echo "$__AF_echo_success1_v0__104_5" > /dev/null 2>&1
    __AF_build_package152_v0=1;
    return 0
}
print_usage__154_v0() {
    local prog=$1
    echo "Usage: ${prog} [--debug] <nix-file>"
    echo ""
    echo "Arguments:"
    echo "  <nix-file>  Path to default.nix file (e.g., pkgs/codex/default.nix)"
    echo ""
    echo "Options:"
    echo "  --debug     Enable debug output"
}
declare -r argv=("$0" "$@")
    debug_mode=0
    nix_file=""
    show_help=0
    for arg in "${argv[@]}"; do
        if [ $([ "_${arg}" != "_--debug" ]; echo $?) != 0 ]; then
            debug_mode=1
fi
        if [ $(echo $([ "_${arg}" != "_--help" ]; echo $?) '||' $([ "_${arg}" != "_-h" ]; echo $?) | bc -l | sed '/\./ s/\.\{0,1\}0\{1,\}$//') != 0 ]; then
            show_help=1
fi
        if [ $(echo $(echo $(echo $([ "_${arg}" == "_--debug" ]; echo $?) '&&' $([ "_${arg}" == "_--help" ]; echo $?) | bc -l | sed '/\./ s/\.\{0,1\}0\{1,\}$//') '&&' $([ "_${arg}" == "_-h" ]; echo $?) | bc -l | sed '/\./ s/\.\{0,1\}0\{1,\}$//') '&&' $([ "_${arg}" == "_${argv[0]}" ]; echo $?) | bc -l | sed '/\./ s/\.\{0,1\}0\{1,\}$//') != 0 ]; then
            if [ $([ "_${nix_file}" != "_" ]; echo $?) != 0 ]; then
                nix_file="${arg}"
fi
fi
done
    if [ ${show_help} != 0 ]; then
        print_usage__154_v0 "${argv[0]}";
        __AF_print_usage154_v0__38_9="$__AF_print_usage154_v0";
        echo "$__AF_print_usage154_v0__38_9" > /dev/null 2>&1
        exit 0
fi
    if [ ${debug_mode} != 0 ]; then
        set_debug__126_v0 1;
        __AF_set_debug126_v0__43_9="$__AF_set_debug126_v0";
        echo "$__AF_set_debug126_v0__43_9" > /dev/null 2>&1
fi
    if [ $([ "_${nix_file}" != "_" ]; echo $?) != 0 ]; then
        echo_error__3_v0 "Missing required argument: <nix-file>";
        __AF_echo_error3_v0__47_9="$__AF_echo_error3_v0";
        echo "$__AF_echo_error3_v0__47_9" > /dev/null 2>&1
        print_usage__154_v0 "${argv[0]}";
        __AF_print_usage154_v0__48_9="$__AF_print_usage154_v0";
        echo "$__AF_print_usage154_v0__48_9" > /dev/null 2>&1
        exit 1
fi
    require_cmd__123_v0 "nix";
    __AF_require_cmd123_v0__52_5="$__AF_require_cmd123_v0";
    echo "$__AF_require_cmd123_v0__52_5" > /dev/null 2>&1
    require_cmd__123_v0 "jq";
    __AF_require_cmd123_v0__53_5="$__AF_require_cmd123_v0";
    echo "$__AF_require_cmd123_v0__53_5" > /dev/null 2>&1
    require_cmd__123_v0 "rg";
    __AF_require_cmd123_v0__54_5="$__AF_require_cmd123_v0";
    echo "$__AF_require_cmd123_v0__54_5" > /dev/null 2>&1
    require_cmd__123_v0 "sed";
    __AF_require_cmd123_v0__55_5="$__AF_require_cmd123_v0";
    echo "$__AF_require_cmd123_v0__55_5" > /dev/null 2>&1
    __AMBER_VAL_17=$( test -f "${nix_file}" && echo "1" || echo "0" );
    __AS=$?;
    file_exists="${__AMBER_VAL_17}"
    if [ $([ "_${file_exists}" != "_0" ]; echo $?) != 0 ]; then
        echo_error__3_v0 "File not found: ${nix_file}";
        __AF_echo_error3_v0__59_9="$__AF_echo_error3_v0";
        echo "$__AF_echo_error3_v0__59_9" > /dev/null 2>&1
        exit 1
fi
    get_root_dir__6_v0 ;
    __AF_get_root_dir6_v0__63_20="${__AF_get_root_dir6_v0}";
    root_dir="${__AF_get_root_dir6_v0__63_20}"
    debug__127_v0 "ROOT_DIR: ${root_dir}";
    __AF_debug127_v0__64_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__64_5" > /dev/null 2>&1
    detect_pkg_type__131_v0 "${nix_file}";
    __AF_detect_pkg_type131_v0__66_20="${__AF_detect_pkg_type131_v0}";
    pkg_type="${__AF_detect_pkg_type131_v0__66_20}"
    if [ $([ "_${pkg_type}" != "_" ]; echo $?) != 0 ]; then
        echo_error__3_v0 "Could not detect package type (npm/pip/cargo) in ${nix_file}";
        __AF_echo_error3_v0__68_9="$__AF_echo_error3_v0";
        echo "$__AF_echo_error3_v0__68_9" > /dev/null 2>&1
        exit 1
fi
    debug__127_v0 "Package type: ${pkg_type}";
    __AF_debug127_v0__71_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__71_5" > /dev/null 2>&1
    extract_hash_key__132_v0 "${nix_file}";
    __AF_extract_hash_key132_v0__73_20="${__AF_extract_hash_key132_v0}";
    hash_key="${__AF_extract_hash_key132_v0__73_20}"
    if [ $([ "_${hash_key}" != "_" ]; echo $?) != 0 ]; then
        echo_error__3_v0 "Could not extract hash key from ${nix_file}";
        __AF_echo_error3_v0__75_9="$__AF_echo_error3_v0";
        echo "$__AF_echo_error3_v0__75_9" > /dev/null 2>&1
        echo_info__0_v0 "Expected pattern: pkgs.hashfile.\"<key>\"";
        __AF_echo_info0_v0__76_9="$__AF_echo_info0_v0";
        echo "$__AF_echo_info0_v0__76_9" > /dev/null 2>&1
        exit 1
fi
    debug__127_v0 "Hash key: ${hash_key}";
    __AF_debug127_v0__79_5="$__AF_debug127_v0";
    echo "$__AF_debug127_v0__79_5" > /dev/null 2>&1
    echo_info__0_v0 "Building ${hash_key} (${pkg_type})...";
    __AF_echo_info0_v0__81_5="$__AF_echo_info0_v0";
    echo "$__AF_echo_info0_v0__81_5" > /dev/null 2>&1
    build_package__152_v0 "${root_dir}" "${nix_file}" "${hash_key}";
    __AF_build_package152_v0__83_8="$__AF_build_package152_v0";
    if [ "$__AF_build_package152_v0__83_8" != 0 ]; then
        exit 0
else
        exit 1
fi
